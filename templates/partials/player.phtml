<?php 
if (isset($player)) { 
?>
    <section class="player-profile">
        <div class="profile-header">
            <h2 class="profile-nickname"><?= $player->getNickname() ?></h2>
            <div class="profile-image-container">
                <img src="<?= $player->getPortrait() ?>" alt="<?= $player->getNickname() ?>">
            </div>
        </div>

        <?php 
        require "templates/partials/player/_state.phtml"; 
        ?>

        <div class="teammates-section">
            <h3>SA TEAM</h3>
            
            <div class="vrap_teams">
                <?php 
                $teammatesFound = false;
                
                if (isset($data['teams'])) {
                    $currentTeamId = $player->getTeam();
                    $currentTeamObj = null;

                    foreach ($data['teams'] as $t) {
                        if ($t->getId() == $currentTeamId) {
                            $currentTeamObj = $t;
                            break;
                        }
                    }

                    if ($currentTeamObj) {
                        $allPlayersInTeam = $currentTeamObj->getPlayers();
                        
                        foreach ($allPlayersInTeam as $teammate) {
                            if ($teammate->getId() !== $player->getId()) {
                                $teammatesFound = true;
                ?>
                                <div class="column_player">
                                    <img src="<?= $teammate->getPortrait() ?>" alt="<?= $teammate->getNickname() ?>">
                                    <h3 class="teammate-name"><?= $teammate->getNickname() ?></h3>
                                    
                                    <a href="index.php?route=player&id=<?= $teammate->getId() ?>">
                                        <button type="button">DÉCOUVREZ <?= $teammate->getNickname() ?></button>
                                    </a>
                                </div>
                <?php 
                            }
                        }
                    }
                }
                
                if (!$teammatesFound) {
                    echo "<p>Aucun coéquipier trouvé.</p>";
                }
                ?>
            </div>
        </div>
        
        <div class="back-btn-container">
             <a href="index.php?route=player" class="btn-back">RETOUR À LA LISTE</a>
        </div>
    </section>

<?php 
} 

else { 
?>
    <section class="players">
        <?php 
        $teamsById = [];
        if (isset($data['teams'])) {
            foreach ($data['teams'] as $t) {
                $teamsById[$t->getId()] = $t;
            }
        }
        ?>

        <div class="contenue_player">
            <h2>LES PLAYERS DE LA LEAGUE</h2>
            
            <?php if (isset($players) && !empty($players)) { ?>
                <div class="vrap_teams"> 
                    <?php foreach ($players as $playerItem) { ?>
                        <div class="column_player">
                            <img src='<?= $playerItem->getPortrait() ?>' alt="Portrait">
                            <h3><?= $playerItem->getNickname() ?></h3>
                            
                            <h4>
                            <?php 
                            $teamId = $playerItem->getTeam();
                            if (isset($teamsById[$teamId])) {
                                echo $teamsById[$teamId]->getName(); 
                            } else {
                                echo "Team #" . $teamId;
                            }
                            ?>
                            </h4>
                            
                            <a href="index.php?route=player&id=<?= $playerItem->getId() ?>">
                                <button type="button">Découvrez <?= $playerItem->getNickname() ?></button>
                            </a>
                        </div>
                    <?php } ?>
                </div>
            <?php } else { ?>
                <p>Aucun joueur trouvé.</p>
            <?php } ?>
        </div>
    </section>
<?php 
} 
?>